var game={data:{score:0},onload:function(){return me.video.init("screen",me.video.CANVAS,800,600,!0,"auto")?(me.audio.init("mp3,ogg"),me.loader.onload=this.loaded.bind(this),me.loader.preload(game.resources),me.state.change(me.state.LOADING),void("#debug"===document.location.hash&&window.onReady(function(){me.plugin.register.defer(this,debugPanel,"debug")}))):void alert("Your browser does not support HTML5 canvas.")},loaded:function(){me.state.set(me.state.PLAY,new game.PlayScreen),me.game.viewport.setBounds(0,0,800,600),me.state.change(me.state.PLAY)}};game.resources=[{name:"melonjs",type:"image",src:"data/img/melonjs.png"},{name:"bg",type:"image",src:"data/img/bg.png"}],game.PlayScreen=me.ScreenObject.extend({onResetEvent:function(){var a=me.loader.getImage("melonjs"),b=me.loader.getImage("bg");this.bg=new me.Sprite(0,0,b),this.logo=new me.Sprite(me.video.renderer.getWidth()/2-a.width/2,me.video.renderer.getHeight()/2-a.height/2,a),me.game.world.addChild(this.bg,1),me.game.world.addChild(this.logo,2),this.logo.resize(.1);new me.Tween(this.logo.scale).to({x:2,y:2},3e3).repeat(1/0).yoyo(!0).easing(me.Tween.Easing.Cubic.InOut).start()},onDestroyEvent:function(){me.game.world.removeChild(this.logo)}}),function(){me.debug=me.debug||{},debugPanel=me.plugin.Base.extend({init:function(a,b){this._super(me.plugin.Base,"init"),this.version="1.1.0",this.area={},this.rect=null,this.z=1/0,this.visible=!1,this.frameUpdateTime=0,this.frameDrawTime=0,this.rect=new me.Rect(0,0,me.video.renderer.getWidth(),35),this.GUID="debug-"+me.utils.createGUID(),this.name="me.debugPanel",this.isPersistent=!0,this.floating=!0,this.isRenderable=!0,this.alwaysUpdate=!0;var c=10;this.mod=1,me.game.viewport.width<500&&(c=7,this.mod=.7),this.font=new me.Font("courier",c,"white"),this.area.renderHitBox=new me.Rect(160,5,15,15),this.area.renderVelocity=new me.Rect(165,18,15,15),this.area.renderQuadTree=new me.Rect(270,5,15,15),this.area.renderCollisionMap=new me.Rect(270,18,15,15),this.help_str="(s)how/(h)ide",this.help_str_len=this.font.measureText(me.video.renderer.getContext(),this.help_str).width,this.fps_str_len=this.font.measureText(me.video.renderer.getContext(),"00/00 fps").width,this.memoryPositionX=2.2*this.font.measureText(me.video.renderer.getContext(),"Draw   : ").width+310*this.mod,me.debug.displayFPS=!0,me.input.bindKey(a||me.input.KEY.S,"show",!1,!1),me.input.bindKey(b||me.input.KEY.H,"hide",!1,!1);var d=this;this.keyHandler=me.event.subscribe(me.event.KEYDOWN,function(a){"show"===a?d.show():"hide"===a&&d.hide()}),this.levelHandler=me.event.subscribe(me.event.LEVEL_LOADED,function(){var a=me.game.currentLevel.getLayerByName("collision");a&&a.setOpacity(me.debug.renderCollisionMap===!0?1:0)}),this.samples=[],this.patchSystemFn(),this.show()},patchSystemFn:function(){me.debug.renderHitBox=me.debug.renderHitBox||!1,me.debug.renderVelocity=me.debug.renderVelocity||!1,me.debug.renderCollisionMap=me.debug.renderCollisionMap||!1,me.debug.renderQuadTree=me.debug.renderQuadTree||!1;var a=this;me.plugin.patch(me.timer,"update",function(a){this._patched(a),me.timer.countFPS()}),me.plugin.patch(me.game,"update",function(b){var c=window.performance.now();this._patched(b),a.frameUpdateTime=window.performance.now()-c}),me.plugin.patch(me.game,"draw",function(){var b=window.performance.now();this._patched(),a.frameDrawTime=window.performance.now()-b}),me.plugin.patch(me.Sprite,"draw",function(a){this._patched(a),me.debug.renderHitBox&&a.strokeRect(this.left,this.top,this.width,this.height,"green")}),me.plugin.patch(me.Entity,"draw",function(a){if(this._patched(a),me.debug.renderHitBox&&(a.save(),this.getBounds().draw(a,"orange"),a.translate(this.pos.x,this.pos.y),this.body.shapes.length&&this.body.getShape().draw(a,"red"),a.restore()),me.debug.renderVelocity){var b=~~(this.pos.x+this.hWidth),c=~~(this.pos.y+this.hHeight),d=a.getContext();d.strokeStyle="blue",d.lineWidth=1,d.beginPath(),d.moveTo(b,c),d.lineTo(b+~~(this.body.vel.x*this.hWidth),c+~~(this.body.vel.y*this.hHeight)),d.stroke()}})},show:function(){this.visible||(me.input.registerPointerEvent("pointerdown",this.rect,this.onClick.bind(this),!0),me.game.world.addChild(this,1/0),this.visible=!0)},hide:function(){this.visible&&(me.input.releasePointerEvent("pointerdown",this.rect),me.game.world.removeChild(this),this.visible=!1)},update:function(){return me.input.isKeyPressed("show")?this.show():me.input.isKeyPressed("hide")&&this.hide(),!0},getBounds:function(){return this.rect},onClick:function(a){if(this.area.renderHitBox.containsPoint(a.gameX,a.gameY))me.debug.renderHitBox=!me.debug.renderHitBox;else if(this.area.renderCollisionMap.containsPoint(a.gameX,a.gameY)){var b=me.game.currentLevel.getLayerByName("collision");b&&(0===b.getOpacity()?(b.setOpacity(1),me.debug.renderCollisionMap=!0):(b.setOpacity(0),me.debug.renderCollisionMap=!1))}else this.area.renderVelocity.containsPoint(a.gameX,a.gameY)?me.debug.renderVelocity=!me.debug.renderVelocity:this.area.renderQuadTree.containsPoint(a.gameX,a.gameY)&&(me.debug.renderQuadTree=!me.debug.renderQuadTree);me.game.repaint()},drawQuadTreeNode:function(a,b){var c=b.bounds;if(0===b.nodes.length){var d=.4*b.objects.length/me.collision.maxChildren;d>0&&(a.setGlobalAlpha(d),a.fillRect(c.pos.x,c.pos.y,c.width,c.height,"red"))}else for(var e=0;e<b.nodes.length;e+=1)this.drawQuadTreeNode(a,b.nodes[e])},drawQuadTree:function(a){var b=a.globalAlpha();a.translate(-me.game.viewport.pos.x,-me.game.viewport.pos.y),this.drawQuadTreeNode(a,me.collision.quadTree),a.translate(me.game.viewport.pos.x,me.game.viewport.pos.y),a.setGlobalAlpha(b)},drawMemoryGraph:function(a,b){if(window.performance&&window.performance.memory){var c=a.getContext(),d=Number.prototype.round(window.performance.memory.usedJSHeapSize/1048576,2),e=Number.prototype.round(window.performance.memory.totalJSHeapSize/1048576,2),f=b-this.memoryPositionX;this.samples.shift(),this.samples[f]=d/e*25;for(var g=f;g>=0;g--){var h=b-(f-g);c.beginPath(),c.strokeStyle="lightblue",c.moveTo(h,30*this.mod),c.lineTo(h,(30-(this.samples[g]||0))*this.mod),c.stroke()}this.font.draw(c,"Heap : "+d+"/"+e+" MB",this.memoryPositionX,5*this.mod)}else this.font.draw(a.getContext(),"Heap : ??/?? MB",this.memoryPositionX,5*this.mod)},draw:function(a){a.save(),me.debug.renderQuadTree===!0&&this.drawQuadTree(a),a.setGlobalAlpha(.5),a.fillRect(this.rect.left,this.rect.top,this.rect.width,this.rect.height,"black"),a.setGlobalAlpha(1);var b=a.getContext();this.font.draw(b,"#objects : "+me.game.world.children.length,5*this.mod,5*this.mod),this.font.draw(b,"#draws   : "+me.game.world.drawCount,5*this.mod,18*this.mod),this.font.draw(b,"?hitbox   ["+(me.debug.renderHitBox?"x":" ")+"]",100*this.mod,5*this.mod),this.font.draw(b,"?velocity ["+(me.debug.renderVelocity?"x":" ")+"]",100*this.mod,18*this.mod),this.font.draw(b,"?QuadTree   ["+(me.debug.renderQuadTree?"x":" ")+"]",200*this.mod,5*this.mod),this.font.draw(b,"?col. layer ["+(me.debug.renderCollisionMap?"x":" ")+"]",200*this.mod,18*this.mod),this.font.draw(b,"Update : "+this.frameUpdateTime.toFixed(2)+" ms",310*this.mod,5*this.mod),this.font.draw(b,"Draw   : "+this.frameDrawTime.toFixed(2)+" ms",310*this.mod,18*this.mod);var c=this.rect.width-25;this.drawMemoryGraph(a,c-this.help_str_len),this.font.draw(b,this.help_str,c-this.help_str_len,18*this.mod);var d=""+me.timer.fps+"/"+me.sys.fps+" fps";this.font.draw(b,d,this.rect.width-this.fps_str_len-5,5*this.mod),a.restore()},onDestroyEvent:function(){this.hide(),me.input.unbindKey(me.input.KEY.S),me.input.unbindKey(me.input.KEY.H),me.event.unsubscribe(this.keyHandler),me.event.unsubscribe(this.levelHandler)}})}(window);